{% extends "base/base.html" %}

{# =============== list_stats macro =============== #}
{% macro list_stats(stats_list, heading, user_path = []) %}
    {% set username_field = "__".join (user_path + ["username"]) %}
    {% set country_field = "__".join (user_path + ["userprofile__country"]) %}

    <table class="userstatlist statistics">
        <tr>
            <th>{{ gettext("User") }}</th>
            <th>{{ gettext(heading) }}</th>
        </tr>
        
        {% for stat in stats_list if stat['count'] != 0 %}
            <tr class="{{ loop.cycle('row1', 'row2') }}">
                <td>
                    <span>
                        {{ dv.flag(stat[country_field]) }}
                        <a href="/demovibes/user/{{ stat[username_field]|e }}/">{{ stat[username_field]|e }}</a>
                    </span>
                </td>
                <td>{{ stat['count'] }}</td>
            </tr>
        {% endfor %}
    </table>
{% endmacro %}
    
{% block main %}
    {% cache 86400 "users_overview_html" %}
        <div id="users_overview">
            {# =============== Top voters =============== #}
            <div id="top_voters">
                <h2>
                    <img class="icon_header" src="{{ STATIC_URL }}statistics.png" alt="" />
                    {{ gettext("Top voters") }}
                </h2>
                <table class="userstatlist statistics">
                    <tr>
                        <th>{{ gettext("User") }}</th>
                        <th>{{ gettext("Votes") }}</th>
                        <th>{{ gettext("Average vote") }}</th>
                    </tr>
                    
                    {% for stat in by_votes_q if stat['count'] != 0 %}
                        <tr class="{{ loop.cycle('row1', 'row2') }}">
                            <td>
                                <span>
                                    {{ dv.flag(stat['userprofile__country']) }}
                                    <a href="/demovibes/user/{{ stat['username']|e }}/">{{ stat['username']|e }}</a>
                                </span>
                            </td>
                            <td>{{ stat['count'] }}</td>
                            <td>{{ stat['avg']|round(1) }}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            
            {# =============== Top uploaders =============== #}
            <div id="top_uploaders">
                <h2>
                    <img class="icon_header" src="{{ STATIC_URL }}statistics.png" alt="" />
                    {{ gettext("Top uploaders") }}
                </h2>
                {{ list_stats(by_uploads_q, 'Uploads', user_path = ['uploaded_by']) }}
            </div>
            
            {# =============== Top oneliners =============== #}
            <div id="top_oneliners">
                <h2>
                    <img class="icon_header" src="{{ STATIC_URL }}statistics.png" alt="" />
                    {{ gettext("Top oneliners") }}
                </h2>
                {{ list_stats(by_oneliner_q, 'Spoken') }}
            </div>
            
            {# =============== Top tag setters =============== #}
            <div id="top_taggers">
                <h2>
                    <img class="icon_header" src="{{ STATIC_URL }}statistics.png" alt="" />
                    {{ gettext("Top taggers") }}
                </h2>
                {{ list_stats(by_tagging_q, 'Changes', user_path = ['user']) }}
            </div>
            
            {# =============== Top requester =============== #}
            <div id="top_requesters">
                <h2>
                    <img class="icon_header" src="{{ STATIC_URL }}statistics.png" alt="" />
                    {{ gettext("Top requesters") }}
                </h2>
                {{ list_stats(by_requester_q, 'Requests', user_path = ['requested_by']) }}
            </div>
            
            {# =============== Top posters =============== #}
            <div id="top_posters">
                <h2>
                    <img class="icon_header" src="{{ STATIC_URL }}statistics.png" alt="" />
                    {{ gettext("Top forum posters") }}
                </h2>
                {{ list_stats(by_posts_q, 'Posts', user_path = ['author']) }}
            </div>
            
            {# =============== Top commentators =============== #}
            <div id="top_commentators">
                <h2>
                    <img class="icon_header" src="{{ STATIC_URL }}statistics.png" alt="" />
                    {{ gettext("Top song commentators") }}
                </h2>
                {{ list_stats(by_comments_q, 'Comments', user_path = ['user']) }}
            </div>
        </div>
    {% endcache %}
{% endblock %}
        
